# Free Space (macOS) — 入口页

目标：用一条命令清理大部分用户级缓存，必要时再按需深度清理。

推荐流程（按顺序）：

1. `./MacOs/1.clean-user-caches.sh`
2. `./MacOs/2.post-reboot-maintenance.sh`

## 快速开始

```bash
# 先预览（默认 dry-run，不会删除）
./MacOs/1.clean-user-caches.sh --dry-run

# 确认后执行（默认会清：VS Code + Apple UI + Siri + Homebrew + Logs + Xcode + Apple ML + Telegram 等常见缓存）
./MacOs/1.clean-user-caches.sh --yes

# 重启后再跑（默认会重建 Spotlight 索引；可用 --no-reindex-spotlight 关闭）
./MacOs/2.post-reboot-maintenance.sh
```

## VS Code 内置 Terminal 推荐

```bash
# 不影响当前 VS Code 会话：保留 VS Code 缓存
./MacOs/1.clean-user-caches.sh --yes --exclude-vscode

# 想清 VS Code 缓存并自动重启 VS Code（会关闭当前 VS Code）
./MacOs/1.clean-user-caches.sh --yes --quit-vscode --restart-vscode
```

## 排除某些默认清理项（可选）

```bash
# 不清 Logs
./MacOs/1.clean-user-caches.sh --yes --exclude-logs

# 不清 Xcode / Apple ML / Telegram
./MacOs/1.clean-user-caches.sh --yes --exclude-xcode --exclude-apple-ml --exclude-telegram
```

## Time Machine 本地快照（可选）

```bash
tmutil listlocalsnapshots /
tmutil deletelocalsnapshots 2025-01-06-052634
```

## Terminal 图标/符号显示异常（恢复）

优先顺序：重启 → 检查 Nerd Font → 必要时重建字体缓存：

```bash
sudo atsutil databases -remove
atsutil server -shutdown
atsutil server -ping
```

## 归档

原本的手工清单已迁移到：`./MacOs/FreeSpace.legacy.md`

---

<!--
LEGACY CONTENT BELOW (archived in ./MacOs/FreeSpace.legacy.md)

# Get the Time Machine local snapshot name

```bash
# 推荐：列出本机 APFS 卷(通常是 /)上的本地快照
tmutil listlocalsnapshots /
```

# Remove a Time Machine local snapshot

```bash
# 注意：不要带尖括号，直接传 snapshot 名称
tmutil deletelocalsnapshots 2025-01-06-052634
```

# try to remove caches

## ✅ 相对安全（用户级缓存）

```bash
# 一般安全：只会影响当前用户的应用缓存；可能导致首次启动变慢、需要重新登录/重新索引。
# 但“全删”偶尔会触发字体/图标缓存重建，短时间出现 terminal/icon 显示异常（见文末恢复）。
find ~/Library/Caches -mindepth 1 -maxdepth 1 -exec rm -rf {} +
```

## ⚠️ 不建议（系统级缓存）

```bash
# 不建议：会清空所有用户/系统服务的共享缓存；需要 sudo；可能引发系统/应用异常或反复重建缓存。
# 如果你不明确知道自己在做什么，尽量不要跑这条。
# sudo rm -rf /Library/Caches/*

# 强烈不建议：/System 受 SIP 保护；即便部分能删，也可能造成系统不稳定或奇怪的 UI/字体行为。
# 这类路径的清理由系统自行维护，通常不该手动 rm。
# sudo rm -rf /System/Library/Caches/*
```

# remove Xcode junk

```bash
# ✅ 通常安全：只是删除模拟器/编译缓存，代价是下次打开 Xcode 或启动模拟器更慢
rm -rf ~/Library/Developer/CoreSimulator/Caches

# ✅ 通常安全：删除旧设备符号/支持文件
rm -rf ~/Library/Developer/Xcode/iOS\ DeviceSupport

# ✅ 通常安全：删除 Xcode 构建产物
rm -rf ~/Library/Developer/Xcode/DerivedData
```

# Remove WeChat Messages (Temp)

```bash
# ⚠️ 路径高度依赖版本/账号目录：确认是临时目录再删。
# 建议先用 ls / du 确认体积、并确保 WeChat 已退出。
rm -rf ~/Library/Containers/com.tencent.xinWeChat/Data/Library/Application\ Support/com.tencent.xinWeChat/2.0b4.0.9/62e8bf572309d9a54cc1194863436161/Message/MessageTemp
```

# Remove Teams caches

```bash
# ✅ 通常安全：缓存会重建；建议退出 Teams 再删
osascript -e 'quit app "Microsoft Teams"'
sleep 2
pkill -x "Microsoft Teams" 2>/dev/null || true

rm -rf ~/Library/Containers/com.microsoft.teams2/Data/Library/Caches/Microsoft/MSTeams
rm -rf ~/Library/Containers/com.microsoft.teams2/Data/Library/Caches/Microsoft/com.microsoft.teams2
rm -rf ~/Library/Containers/com.microsoft.teams2/Data/Library/Caches/Microsoft/com.microsoft.teams2.modulehost
rm -rf ~/Library/Containers/com.microsoft.teams2/Data/Library/Caches/Microsoft/WebKit
```

# Remove Discord caches

```bash
# ✅ 通常安全：缓存会重建
rm -rf ~/Library/Application\ Support/discord/Cache
```

# remove VS Code caches

```bash
# ✅ 通常安全：不需要 sudo（在你的主目录下）
rm -rf ~/Library/Application\ Support/Code/Cache
```

# remove Telegram caches/media

```bash
# ⚠️ 这可能包含下载的媒体文件；一般不会影响聊天记录本身，但会导致图片/视频重新下载。
rm -rf ~/Library/Group\ Containers/6N38VWS5BX.ru.keepcoder.Telegram/stable/account-17560967941536714162/postbox/media
```

# remove Apple wallpaper caches

```bash
# ✅ 通常安全：系统会重建
rm -rf ~/Library/Containers/com.apple.wallpaper.agent/Data/Library/Caches/com.apple.wallpaper.caches

# ✅ 通常安全：定位/地图相关缓存会重建
rm -rf ~/Library/Containers/com.apple.geod/Data/Library/Caches/com.apple.geod

# ✅ 通常安全：照片/媒体分析缓存会重建，但可能导致后台重新分析、短期 CPU 占用上升
rm -rf ~/Library/Containers/com.apple.mediaanalysisd/Data/Library/Caches/PFSceneGeographyData.index
rm -rf ~/Library/Containers/com.apple.mediaanalysisd/Data/Library/Caches/com.apple.mediaanalysisd
rm -rf ~/Library/Containers/com.apple.mediaanalysisd/Data/Library/Caches/PFSceneTaxonomyData.index
rm -rf ~/Library/Containers/com.apple.mediaanalysisd/Data/Library/Caches/com.apple.VisualIntelligence

rm -rf ~/Library/Containers/com.apple.photoanalysisd/Data/Library/Caches/
```

# Remove logs

```bash
# ✅ 通常安全：只是日志；应用可能重新生成
rm -rf ~/Library/Logs
```

# Images takes lots of space, but I don't know is it safe to delete them

# cannot be deleted with sudo.

<!-- rm -rf /Library/Developer/CoreSimulator/Images -->

# Remove npx cache

```bash
# ✅ 通常安全
rm -rf ~/.npm/_npx
```

# /private/var/tmp

```bash
# ⚠️ 谨慎：系统/安装器/某些工具可能临时使用；建议只删你确认不再需要的子目录。
# 更安全的做法：列出来看一下再删
ls -lah /private/var/tmp
# rm -rf /private/var/tmp/<some-folder>
```

---

# 一键清理（默认安全）

仓库里提供了一个默认更安全的脚本：只清理“当前用户”的常见缓存，不碰 `/System`，也不默认清 `/Library/Caches`。

```bash
# 先预览（默认就是 dry-run）
./MacOs/1.clean-user-caches.sh --dry-run

# 如果遇到“permission denied / Exit Code 126”，可以用 bash 直接跑
bash ./MacOs/1.clean-user-caches.sh --dry-run

# 确认没问题后再执行
./MacOs/1.clean-user-caches.sh --yes --quit-apps --include-logs

# 更激进（仍然只在用户目录内）
./MacOs/1.clean-user-caches.sh --yes --quit-apps --include-xcode --include-apple-ml

# 默认已经包含：VS Code + 壁纸/定位/News/iBooks + Siri + Homebrew 缓存
./MacOs/1.clean-user-caches.sh --yes --quit-apps

# 如果你是在 VS Code 的内置 Terminal 里运行：建议不要清 VS Code 自己的缓存，也不要让脚本退出 VS Code
# （否则 VS Code 会关闭，Terminal 也会断）

# 在 VS Code 内置 Terminal 的推荐用法：保留 VS Code 缓存
./MacOs/1.clean-user-caches.sh --yes --quit-apps --exclude-vscode

# 只有当你愿意让 VS Code 退出并在结束后自动重启时，再显式启用：
#（不加 --exclude-vscode，即会清理 VS Code 缓存）
./MacOs/1.clean-user-caches.sh --yes --quit-apps --quit-vscode --restart-vscode

# 关于 macOS 弹窗：
# 如果你看到 “Visual Studio Code would like to access data from other apps.”
# 这通常是因为脚本用到了 osascript（AppleScript 自动化）去“优雅退出”其他 App。
# 当前脚本的 --quit-apps 默认只用 pkill，不会触发这个弹窗。
# 只有当你显式加上 --graceful-quit 时，才会用 osascript（可能触发弹窗）。
```

---

# Terminal 里 icon/符号显示异常（可能和“全删缓存”相关）

你描述的“Terminal 里有些 icon 不再正常显示”，更常见原因不是“icon 文件被删了”，而是：

- 终端使用的 Nerd Font/图标字体未生效（或字体缓存重建中）
- 字体缓存被清空后短期异常，需要重建/重启

建议按下面顺序排查/恢复：

1. 重启（最有效的一步）

2. 确认终端字体设置

- Terminal.app：Settings/Profiles 里确认使用你预期的字体（很多主题需要 Nerd Font）
- iTerm2：Profiles -> Text -> Font

3. 只在“字体显示明显异常”时，重建字体缓存（谨慎执行）

```bash
# 这会触发字体缓存重建，可能需要重启后才完全恢复
sudo atsutil databases -remove
atsutil server -shutdown
atsutil server -ping
```

4. 如果是 shell 主题/提示符的图标问题

- 例如 Oh My Zsh / Starship / Powerlevel10k 的图标需要 Nerd Font。
- 即使缓存清理没问题，只要字体没选对，也会变成方框/问号。

---

<!-- CLeanMyMac -->

/Users/mingz/Library/Caches/SiriTTS
/Users/mingz/Library/Containers/com.microsoft.Outlook/Data/Library/Caches/WebKit
/Users/mingz/Library/Containers/com.microsoft.Outlook/Data/Library/Caches/com.microsoft.Outlook
/Users/mingz/Library/Containers/com.microsoft.Outlook/Data/Library/Caches/com.microsoft.powerlift.sqlite3
/Users/mingz/Library/Containers/com.microsoft.Outlook/Data/Library/Caches/Microsoft
/Users/mingz/Library/Containers/com.apple.mediaanalysisd/Data/Library/Caches/com.apple.mediaanalysisd
/Users/mingz/Library/Containers/com.apple.news.widget/Data/Library/Caches/com.apple.news.public-production-143465
/Users/mingz/Library/Containers/com.apple.news.widget/Data/Library/Caches/com.apple.news.public-production-143455
/Users/mingz/Library/Containers/com.apple.news.widget/Data/Library/Caches/widget-assets-assetstore
/Users/mingz/Library/Containers/com.apple.news.widget/Data/Library/Caches/shared-assets-assetstore
/Users/mingz/Library/Containers/com.apple.news.widget/Data/Library/Caches/com.apple.news.widget
/Users/mingz/Library/Containers/com.apple.news.widget/Data/Library/Caches/D3B1A916-12CB-4CA1-9DA7-BFBC1ACD097A
/Users/mingz/Library/Containers/com.apple.news.widget/Data/Library/Caches/A2D4800C-2268-462D-B110-3310E2B31F64
/Users/mingz/Library/Containers/com.apple.iBooksX/Data/Library/Caches/BCCoverCache-1
/Users/mingz/Library/Containers/com.apple.iBooksX/Data/Library/Caches/com.apple.iBooksX

....
brew cleanup -s
brew autoremove
